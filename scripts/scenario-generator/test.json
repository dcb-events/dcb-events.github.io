{
  "meta": {
    "version": "1.0",
    "id": "opt_in_token_02",
    "extends": "opt_in_token_01"
  },
  "projections": [
    {
      "name": "pendingSignUp",
      "parameterSchema": {
        "type": "object",
        "properties": {
          "emailAddress": {
            "type": "string"
          },
          "otp": {
            "type": "string"
          }
        }
      },
      "stateSchema": {
        "type": "object",
        "properties": {
          "data": {
            "type": "object",
            "properties": {
              "name": {
                "type": "string"
              }
            }
          },
          "otpUsed": {
            "type": "boolean"
          },
          "otpExpired": {
            "type": "boolean"
          }
        }
      },
      "handlers": {
        "SignUpInitiated": "({data: event.data, otpUsed: false, otpExpired: event.metadata?.minutesAgo > 60})",
        "SignUpConfirmed": "({...state, otpUsed: true})"
      },
      "tagFilters": [
        "email:{emailAddress}",
        "otp:{otp}"
      ]
    }
  ],
  "commandHandlerDefinitions": [
    {
      "commandName": "confirmSignUp",
      "decisionModels": [
        {
          "name": "pendingSignUp",
          "parameters": [
            "command.emailAddress",
            "command.otp"
          ]
        }
      ],
      "constraintChecks": [
        {
          "condition": "!state.pendingSignUp",
          "errorMessage": "No pending sign-up for this OTP / email address"
        },
        {
          "condition": "state.pendingSignUp.otpUsed",
          "errorMessage": "OTP was already used"
        },
        {
          "condition": "state.pendingSignUp.otpExpired",
          "errorMessage": "OTP expired"
        }
      ],
      "successEvent": {
        "type": "SignUpConfirmed",
        "data": {
          "emailAddress": "{command.emailAddress}",
          "otp": "{command.otp}",
          "name": "{state.pendingSignUp.data.name}"
        }
      }
    }
  ],
  "testCases": [
    {
      "description": "Confirm SignUp for expired OTP",
      "givenEvents": [
        {
          "type": "SignUpInitiated",
          "data": {
            "emailAddress": "john.doe@example.com",
            "otp": "333333",
            "name": "John Doe"
          },
          "metadata": {
            "minutesAgo": "61"
          }
        }
      ],
      "whenCommand": {
        "type": "confirmSignUp",
        "data": {
          "emailAddress": "john.doe@example.com",
          "otp": "000000"
        }
      },
      "thenExpectedError": "No pending sign-up for this OTP / email address"
    }
  ]
}